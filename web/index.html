<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content=width=device-width, initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,
          user-scalable=no">
    <title>WXDOWN</title>
    <link rel="icon" href="/logo.png" type="image/x-icon">
    <meta name="description" content="æ–‡ç« é‡‡é›†ç«™ï¼Œæ”¯æŒå¾®ä¿¡å…¬ä¼—å·æ–‡ç« é‡‡é›†ï¼Œæ”¯æŒæ‰¹é‡é‡‡é›†ï¼Œæ”¯æŒæ‰¹é‡ä¸‹è½½ï¼Œæ”¯æŒæ‰¹é‡è½¬PDF">
    <link rel="stylesheet" href="static/css/main.css">
</head>
<body>
<button class="hide fun-but " id="show">ï¸â–¶ï¸</button>
<aside>
    <!-- å…¬ä¼—å·-->
    <nav>
        <div class="task">
            <div class="box">
                <div id="task" style="overflow: hidden;">
                    <span class="mtask">ğŸ“</span>é‡‡é›†ä»»åŠ¡
                </div>
                <div>
                    <button class="fun-but" title="åˆ·æ–°" onclick="javascript:window.location.reload()">ğŸ”„</button>
                    <button class="sidebar-toggle fun-but" title="æ”¶èµ·æ¥" aria-label="æ”¶èµ·æ¥">â—€ï¸</button>
                </div>
            </div>
            <div>
                <input id="search" type="search" placeholder="è¯·è¾“å…¥åç§°æˆ–æ—¶é—´">
            </div>
        </div>
        <ul id="wx-menus">

        </ul>
    </nav>
    <!--  æ–‡ä»¶åˆ—è¡¨  -->
    <nav class="details">
        <div style="padding: 0 10px;position: sticky;top: 0"><input id="search-html" type="search"
                                                                    placeholder="è¯·è¾“å…¥åç§°æˆ–æ—¶é—´"></div>
        <ul id="wx-article"></ul>
    </nav>
</aside>
<main>
    <section id="section" style="max-width: 1024px;margin: 0 auto;padding: 10px">
        <h2>æ‰¹é‡é‡‡é›†</h2>
        <label>
            <textarea name="" placeholder="è¯·è¾“å…¥æ–‡ç« åœ°å€ï¼Œä¸€è¡Œä¸€ä¸ªåœ°å€"></textarea>
        </label>
        <p>
            <button id="start">å¼€å§‹é‡‡é›†</button>
        </p>
        <h2>åˆé›†é‡‡é›†</h2>
        <p><strong>åˆé›†åˆ†ä¸ºä¸¤ç§ï¼š</strong><code>appmsgalbum</code>å’Œ<code>homepage</code>å‰ç¼€å†…å®¹</p>
        <ol>
            <li>https://mp.weixin.qq.com/mp/homepage</li>
            <li>https://mp.weixin.qq.com/mp/appmsgalbum</li>
        </ol>
        <label>
            <input type="url" id="collect-url"
                   placeholder="è¯·è¾“å…¥åˆé›†åœ°å€ã€‚ä¾‹å¦‚ï¼šhttps://mp.weixin.qq.com/mp/appmsgalbum?xxxxx"
                   style="width: 100%;outline: none;padding: 10px;"/>
        </label>
        <p>
            <button id="collect">å¼€å§‹é‡‡é›†</button>
        </p>

        <hr>
        <h2>ğŸš«ä¸æ”¯æŒæ‰¹é‡è·å–å…¬ä¼—å·å†å²</h2>
        <div id="stats" class="stats">
            <p>ğŸ§Š<strong>èµ„æºåˆ—è¡¨</strong></p>
            <ul>
                <li>âœ…å›¾ç‰‡</li>
                <li>âœ…è§†é¢‘</li>
                <li>âœ…éŸ³é¢‘</li>
                <li>âœ…HTML</li>
            </ul>
            <p>ğŸ§Š<strong>åŠŸèƒ½åˆ—è¡¨</strong></p>
            <ul>
                <li>âœ…HTML è½¬ PDF</li>
                <li>âœ…å•ä¸ªé‡‡é›†æ¥å£</li>
                <li>âœ…æ‰¹é‡é‡‡é›†æ¥å£</li>
                <li>âœ…æ”¯æŒå¹¶å‘é‡‡é›†</li>
            </ul>
            <p>ğŸ§Š<strong>æ•°æ®æ¥æº</strong></p>
            <ul>
                <li>âœ…<a target="_blank" href="help.html#é¦–é¡µåˆé›†">é¦–é¡µåˆé›†</a></li>
                <li>âœ…<a target="_blank" href="help.html#æ ‡ç­¾åˆé›†">æ ‡ç­¾åˆé›†</a></li>
                <li>âœ…å•ä¸ªé“¾æ¥</li>
            </ul>
        </div>
    </section>
    <iframe id="iframe" name="child" width="100%" src="images.html" frameborder="0"></iframe>
</main>


<script>
    // å‘èµ·ä¸€ä¸ª articles get è¯·æ±‚è·å–æ–‡ç« åˆ—è¡¨
    const details = document.querySelector('.details');
    const iframe = document.getElementById('iframe');
    const section = document.getElementById('section');
    const wxArticle = document.getElementById('wx-article');
    const wxMenus = document.getElementById('wx-menus');
    iframe.style.display = 'none'; // éšè— iframe
    section.style.display = 'block'; // é‡‡é›†é¡µé¢
    details.style.display = 'none'; // é‡‡é›†é¡µé¢
    // æ”¹å˜ main å…ƒç´ çš„å®½åº¦
    const changeMainWidth = () => {
        const width = document.documentElement.clientWidth;
        const clientWidth = document.querySelector("aside").clientWidth;
        if (width < 768) {

        } else {
            document.querySelector("main").style.marginLeft = clientWidth + "px";
        }
    }
    // æ”¹å˜ main å…ƒç´ çš„å®½åº¦
    const blockShow = () => {
        details.style.display = 'block'; // æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨
        iframe.style.display = 'block'; // æ˜¾ç¤º iframe
        section.style.display = 'none'; // éšè—é‡‡é›†é¡µé¢
    }
    // éšè—æˆ–æ˜¾ç¤ºå…ƒç´ 
    const showOrHide = () => {
        document.querySelector('aside').classList.toggle('hide')
        document.getElementById('show').classList.toggle('hide')
        changeMainWidth()
    }

    // åˆ›å»º dom
    function CH() {
        const args = arguments;
        const dom = document.createElement(args[0]);
        if (args.length > 1 && args[1]) {
            dom.id = args[1];
        }
        if (args.length > 2) {
            dom.innerText = args[2];
        }
        if (args.length > 3 && args[3]) {
            dom.className = args[3];
        }
        if (args.length > 4 && args[4]) {
            dom.dataset[args[4].key] = args[4].value;
        }
        return dom
    }

    /**
     * è·å–æ–‡ä»¶å¤¹åˆ—è¡¨
     */
    const getFolders = async () => {
        try {
            const folders = await fetch('ats/').then(res => res.json());
            if (folders.length) {
                localStorage.setItem("folders", JSON.stringify(folders))
                return folders;
            }
        } catch (e) {
            console.error(e)
        }
    }

    const getFoldersDetails = async (folder, fType) => {
        try {
            const folders = await fetch(`ats/${folder}/${fType}`).then(res => res.json());
            if (folders.length) {
                localStorage.setItem("foldersDetails", JSON.stringify(folders))
                return folders;
            }
        } catch (e) {
            console.error(e)
        }
    }

    const onFolderEvent = async (event, fType) => {
        blockShow()
        changeMainWidth()
        const target = event.target;
        // è·å–å½“å‰ç‚¹å‡»çš„å…ƒç´ 
        const active = document.querySelector('.active');
        // å¦‚æœå½“å‰å…ƒç´ æœ‰ active ç±»åï¼Œåˆ™ç§»é™¤
        if (active) {
            active.classList.remove('active');
        }
        let listData = [];
        if (!fType) {
            listData = await getFoldersDetails(target.dataset.name, "html");
        } else {
            listData = await getFoldersDetails(target.parentElement.dataset.name, "pdf");
        }
        const length = listData ? listData.length : 0;
        let rootDom = target.parentElement;
        if (target.className === "wx-title") {
        } else if (target.tagName === "BUTTON") {
            rootDom = target.parentElement.parentElement;
        }
        if (rootDom.lastElementChild.tagName !== "SPAN") {
            rootDom.append(CH("span", "", length, "badge"))
        } else {
            rootDom.lastElementChild.innerHTML = length
        }
        // ç»™å½“å‰å…ƒç´ æ·»åŠ  active ç±»å
        rootDom.classList.add('active');
        if (length) {
            const listStr = listData.map((item) => {
                return `<li><time style="color:#fff;font-size: 12px">${item.cteTime}</time><br><a target="child" href="${item.link}">${item.original}</a></li>`
            }).join('')
            wxArticle.innerHTML = `<ul>${listStr}</ul>`
        } else {
            wxArticle.innerHTML = '<p style="color: #FFF;text-align: center">æš‚æ— æ•°æ®!</p>';
        }
        return true
    }
    const onOpenEvent = async (event) => {
        const name = event.dataset.name;
        const folder = event.parentElement.dataset.name;
        const listData = await getFoldersDetails(folder, name);
        iframe.style.display = 'block'; // æ˜¾ç¤º iframe
        section.style.display = 'none'; // éšè—é‡‡é›†é¡µé¢
        details.style.display = 'none'; // éšè—é‡‡é›†é¡µé¢

        const active = document.querySelector('.active');
        // å¦‚æœå½“å‰å…ƒç´ æœ‰ active ç±»åï¼Œåˆ™ç§»é™¤
        if (active) {
            active.classList.remove('active');
        }
        const length = listData ? listData.length : 0;
        let rootDom = event.parentElement.parentElement;
        if (rootDom.lastElementChild.tagName !== "SPAN") {
            rootDom.append(CH("span", "", length, "badge"))
        } else {
            rootDom.lastElementChild.innerHTML = length
        }
        // ç»™å½“å‰å…ƒç´ æ·»åŠ  active ç±»å
        rootDom.classList.add('active');
        changeMainWidth();
        iframe.src = name + '.html'
        setTimeout(() => {
            iframe.contentWindow.postMessage(JSON.stringify(listData))

        }, 100)
        return true
    }
    const rendering = (folders) => {
        wxArticle.innerHTML = ''
        wxMenus.innerHTML = "";
        folders.forEach((item, i) => {
            let li = CH("li");
            li.tabIndex = i;

            let folder = CH("div", "folder-" + i, item.name, "wx-title", {key: 'name', value: item.name});
            folder.className = "wx-title"
            folder.addEventListener('click', (e) => onFolderEvent(e))

            let open = CH("div", "open-" + i, "", "open", {key: 'name', value: item.name});
            open.className = "open"

            let audios = CH("button", null, "ğŸ”Š", "open-event", {key: 'name', value: "audios"});
            audios.title = "éŸ³é¢‘"
            audios.onclick = function () {
                onOpenEvent(this)
            }
            let videos = CH("button", null, "ğŸ¬", "open-event", {key: 'name', value: "videos"});
            videos.title = "è§†é¢‘"
            videos.onclick = function () {
                onOpenEvent(this)
            }
            let images = CH("button", null, "ğŸ–¼ï¸", "open-event", {key: 'name', value: "images"});
            images.title = "å›¾ç‰‡"
            images.onclick = function () {
                onOpenEvent(this)
            }
            let folders = CH("button", null, "ğŸ“‚", "open-event", {key: 'name', value: "folder"});
            folders.title = "æ‰“å¼€æ–‡ä»¶å¤¹"
            folders.onclick = function () {
                fetch("/open/" + this.parentElement.dataset.name, {mode: "no-cors"})
            }
            let pdf = CH("button", null, "ğŸ“", "open-event", {key: 'name', value: "pdfs"});
            pdf.title = "PDF"
            pdf.addEventListener('click', (e) => onFolderEvent(e, "pdfs"))

            open.append(audios)
            open.append(videos)
            open.append(images)
            open.append(pdf)
            open.append(folders)


            li.append(folder)
            li.append(open)
            wxMenus.append(li);
        })
    }
    const init = async () => {
        const folders = await getFolders();
        rendering(folders);
    }

    // åŒ¿åå‡½æ•°
    (() => {
        init()
    })()

    // é‡‡é›†ä»»åŠ¡
    document.getElementById('task').addEventListener('click', () => {
        section.style.display = 'block'
        iframe.style.display = 'none';
        details.style.display = 'none';
        changeMainWidth()
    })

    // å…¨å±€ç›‘å¬ click ç‚¹å‡»äº‹ä»¶
    document.addEventListener("click", function (event) {
        const width = document.documentElement.clientWidth;
        if (width < 768) {
            console.log(event.target)
            if (event.target.tagName === 'A' || ["videos", "audios", "images"].includes(event.target.dataset.name) || event.target.id === "task") {
                showOrHide()
            }
        }
        if (event.target.id === "start") {
            console.log("é‡‡é›†")
            const value = document.querySelector("textarea").value;
            if (value) {
                const strings = value.split("\n");
                if (strings.length === 1) {
                    fetch("/gather/" + value).then(res => res.json()).then(data => {
                        if (data.ok) {
                            alert("é‡‡é›†å®Œæˆ");
                            window.location.reload()
                        }
                    })
                } else {
                    fetch("/gather/", {
                        method: "POST",
                        body: JSON.stringify(strings)
                    }).then(res => res.json()).then(data => {
                        if (data.ok) {
                            alert("é‡‡é›†å®Œæˆ");
                            window.location.reload()
                        }
                    })
                }
            }
        } else if (event.target.id === "collect") {
            const value = document.querySelector("input[type='url']").value;
            try {
                const url = new URL(value);
                if (url.host !== "mp.weixin.qq.com") {
                    alert("ä¸æ”¯æŒé™¤äº† WX ä»¥å¤–é“¾æ¥ï¼");
                    return;
                }
            } catch (e) {
                alert("æ— æ•ˆURLï¼");
                return
            }
            if (value) {
                fetch("/collect/", {
                    method: "POST",
                    body: JSON.stringify({url: value})
                }).then(res => res.json()).then(data => {
                    if (data.ok) {
                        alert("é‡‡é›†å®Œæˆ");
                        window.location.reload()
                    } else {
                        alert(data.message);
                    }
                })
                console.log(value)
            }
        }
    })

    // ä¾§è¾¹æ æ§åˆ¶
    document.querySelector('.sidebar-toggle').addEventListener('click', () => {
        showOrHide()
    })
    // ä¾§è¾¹æ æ§åˆ¶
    document.getElementById('show').addEventListener('click', () => {
        showOrHide()
    })
    // æœç´¢ç›®å½•
    document.getElementById('search').addEventListener('input', (event) => {
        const listData = JSON.parse(localStorage.getItem("folders"));
        const results = listData.filter(item => {
            if (item.name.includes(event.target.value) || item.modTime.includes(event.target.value)) {
                return item;
            }
        })
        rendering(results)
    })
    // æœç´¢ç›®å½•
    document.getElementById('search-html').addEventListener('input', (event) => {
        const listData = JSON.parse(localStorage.getItem("foldersDetails"));
        const results = listData.filter(item => {
            if (item.name.includes(event.target.value) || item.modTime.includes(event.target.value)) {
                return item;
            }
        })
        wxArticle.innerHTML = ''
        if (results.length) {
            const listStr = results.map((item) => {
                return `<li><time style="color:#fff;font-size: 12px">${item.cteTime}</time><br><a target="child" href="${item.link}">${item.original}</a></li>`
            }).join('')
            wxArticle.innerHTML = `<ul>${listStr}</ul>`
        } else {
            wxArticle.innerHTML = '<p style="color: #FFF;text-align: center">æš‚æ— æ•°æ®!</p>';
        }
    })
</script>

</body>
</html>